<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% block title %}Add Image to Library{% endblock %}</title>
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js');
        }
    </script>
    <style>
        body { background: #f8f9fa; }
        .container { max-width: 400px; margin-top: 2rem; }
        #preview { width: 100%; margin-bottom: 1rem; }
    </style>
</head>
<body>
{% block content %}
<div class="container">
    <h3 class="text-center mb-4">Add Image to Library</h3>
    <form id="uploadForm">
        <div class="mb-2">
            <video id="cameraStream" autoplay playsinline style="width:100%;border-radius:8px;"></video>
            <canvas id="snapshot" style="display:none;width:100%;"></canvas>
        </div>
        <button type="button" id="takePhoto" class="btn btn-secondary w-100 mb-2">Make a Picture</button>
        <img id="preview" src="#" alt="Preview" style="display:none;"/>
        <input type="hidden" id="lat" name="lat">
        <input type="hidden" id="lon" name="lon">
        <input type="hidden" id="photoData" name="photoData">
        <button type="submit" class="btn btn-primary w-100">Upload</button>
    </form>
    <div id="result" class="mt-3"></div>
</div>
<script>
// Camera access and photo capture
const video = document.getElementById('cameraStream');
const canvas = document.getElementById('snapshot');
const preview = document.getElementById('preview');
const takePhotoBtn = document.getElementById('takePhoto');

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            video.srcObject = stream;
            video.play();
        })
        .catch(function(err) {
            alert('Camera access denied or not available.');
        });
} else {
    alert('Camera API not supported in this browser.');
}

takePhotoBtn.addEventListener('click', function(e) {
    e.preventDefault();
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg');
    preview.src = dataUrl;
    preview.style.display = 'block';
    document.getElementById('photoData').value = dataUrl;
});
</script>
{% endblock %}
</body>
</html>
